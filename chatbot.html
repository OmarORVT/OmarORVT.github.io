<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuimiBot v2.0 - Chatbot de Química Mejorado</title>
    <link rel="stylesheet" href="CSS/estilos.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .chat-container {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 0;
            margin: 2rem auto;
            max-width: 900px;
            height: 700px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: white;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .chat-header .avatar {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .chat-header .info h2 {
            margin: 0;
            color: white;
            font-size: 1.3rem;
        }
        
        .chat-header .info p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .chat-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: auto;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #4ade80;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: #fafafa;
        }
        
        .message {
            display: flex;
            gap: 0.8rem;
            max-width: 80%;
            animation: messageSlide 0.3s ease-out;
        }
        
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        
        .message.bot {
            align-self: flex-start;
        }
        
        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }
        
        .message.user .message-avatar {
            background: var(--color-primary);
            color: white;
        }
        
        .message.bot .message-avatar {
            background: var(--color-secondary);
            color: white;
        }
        
        .message-content {
            background: white;
            padding: 1rem 1.2rem;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            word-wrap: break-word;
        }
        
        .message.user .message-content {
            background: var(--color-primary);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message.bot .message-content {
            background: white;
            color: var(--color-text);
            border-bottom-left-radius: 4px;
            border: 1px solid #e5e7eb;
        }
        
        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 0.3rem;
        }
        
        .typing-indicator {
            display: none;
            align-self: flex-start;
            max-width: 80%;
        }
        
        .typing-content {
            background: white;
            padding: 1rem 1.2rem;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 0.3rem;
            align-items: center;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #9ca3af;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-8px); opacity: 1; }
        }
        
        .chat-input-container {
            padding: 1.5rem;
            background: white;
            border-top: 1px solid #e5e7eb;
        }
        
        .chat-input {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }
        
        .input-field {
            flex-grow: 1;
            min-height: 50px;
            max-height: 120px;
            padding: 0.8rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            font-size: 1rem;
            resize: none;
            outline: none;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        .input-field:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(44, 120, 115, 0.1);
        }
        
        .send-button {
            width: 50px;
            height: 50px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .send-button:hover {
            background: var(--color-accent);
            transform: scale(1.05);
        }
        
        .send-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .quick-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            max-height: 120px;
            overflow-y: auto;
        }
        
        .quick-action {
            background: white;
            border: 1px solid var(--color-primary);
            color: var(--color-primary);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .quick-action:hover {
            background: var(--color-primary);
            color: white;
        }
        
        .connection-status {
            background: #dbeafe;
            color: #1e40af;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .welcome-message {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        
        .welcome-message h3 {
            color: var(--color-primary);
            margin-bottom: 1rem;
        }
        
        .version-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .chat-container {
                margin: 1rem;
                height: calc(100vh - 2rem);
            }
            
            .message {
                max-width: 90%;
            }
            
            .quick-actions {
                justify-content: center;
            }
            
            .quick-action {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="contenedor">
            <nav class="menu">
                <a href="index.html"><b>Inicio</b></a>
                <a href="indexT1.html"><b>Tema 1</b></a>
                <a href="indexT2.html"><b>Tema 2</b></a>
                <a href="Tabla.html"><b>Tabla Periódica</b></a>
                <a href="cuestionario-tema1.html"><b>Cuestionario T1</b></a>
                <a href="cuestionario-tema2.html"><b>Cuestionario T2</b></a>
                <a href="chatbot.html"><b>Chatbot</b></a>
            </nav>
            <div class="contenido-header">
                <h1 class="titulo-header"><b>QUIMIBOT v2.0 - CHATBOT DE QUÍMICA MEJORADO</b></h1>
                <samp class="linea-header"></samp>
                <h2 class="texto-header">
                    Asistente virtual inteligente con base de conocimientos expandida y búsqueda avanzada
                </h2>
                <a href="index.html" class="action-header"><b>Volver al Inicio</b></a>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="chat-container">
            <div class="chat-header">
                <div class="avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="info">
                    <h2>QuimiBot <span class="version-badge">v2.0</span></h2>
                    <p>Tu asistente personal de química mejorado</p>
                </div>
                <div class="chat-status">
                    <div class="status-indicator"></div>
                    <span id="status-text">En línea</span>
                </div>
            </div>
            
            <div class="chat-messages" id="chat-messages">
                <div class="connection-status" id="connection-status">
                    <i class="fas fa-info-circle"></i> Funcionando con base de conocimientos expandida (90+ conceptos)
                </div>
                
                <div class="welcome-message">
                    <h3><i class="fas fa-flask"></i> ¡Bienvenido a QuimiBot v2.0!</h3>
                    <p>Soy tu asistente virtual especializado en química con capacidades mejoradas. Ahora puedo ayudarte con:</p>
                    <ul style="text-align: left; display: inline-block; margin-top: 1rem;">
                        <li><strong>Estructura atómica</strong>: protones, neutrones, electrones, modelos atómicos</li>
                        <li><strong>Teoría cuántica</strong>: números cuánticos, orbitales, configuración electrónica</li>
                        <li><strong>Tabla periódica</strong>: grupos, períodos, propiedades periódicas</li>
                        <li><strong>Enlaces químicos</strong>: iónico, covalente, metálico</li>
                        <li><strong>Reacciones químicas</strong>: balanceo, estequiometría</li>
                        <li><strong>Estados de la materia</strong> y cambios de fase</li>
                        <li><strong>Ácidos y bases</strong>: pH, neutralización</li>
                        <li><strong>Aplicaciones tecnológicas</strong> de la química</li>
                    </ul>
                    <p style="margin-top: 1rem; font-style: italic;">
                        <strong>Nuevas características:</strong> Búsqueda inteligente, tolerancia a errores ortográficos, 
                        insensible a mayúsculas y acentos.
                    </p>
                </div>
            </div>
            
            <div class="typing-indicator" id="typing-indicator">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="typing-content">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="quick-actions" id="quick-actions">
                    <!-- Las preguntas sugeridas se cargarán dinámicamente -->
                </div>
                
                <div class="chat-input">
                    <textarea 
                        id="user-input" 
                        class="input-field" 
                        placeholder="Escribe tu pregunta sobre química... (ahora con búsqueda inteligente)"
                        rows="1"
                        autocomplete="off"
                    ></textarea>
                    <button id="send-btn" class="send-button">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="site-footer">
        <div class="footer-content">
            <div class="contact-info">
                <h3>Contacto</h3>
                <p><strong>Teléfono:</strong> +52 123 456 7890</p>
                <p><strong>Email:</strong> correo@hacer.com</p>
                <p><strong>Dirección:</strong> TECNM, H. Matamoros</p>
            </div>
            
            <div class="social-media">
                <h3>Síguenos</h3>
                <ul class="social-links">
                    <li><a href="https://facebook.com" target="_blank"><i class="fab fa-facebook"></i> Facebook</a></li>
                    <li><a href="https://instagram.com" target="_blank"><i class="fab fa-instagram"></i> Instagram</a></li>
                    <li><a href="https://twitter.com" target="_blank"><i class="fab fa-twitter"></i> Twitter</a></li>
                </ul>
            </div>
            
            <div class="quick-links">
                <h3>Autores</h3>
                <ul>
                    <li>Andrade Zertuche Carlos Alberto</li>
                    <li>Campos Guillermo Ulises Daniel</li>
                    <li>Covarruvias Ramírez Ricardo Daniel</li>
                    <li>Curiel Román Omar</li>
                    <li>Segura Lopez Estefanie</li>
                    <li>Villanueva Martinez Alfredo</li>
                </ul>
            </div>
            
            <div class="contact-form">
                <h3>Envíanos un mensaje</h3>
                <form action="" class="formulario" method="POST">
                    <input type="text" placeholder="Nombre" id="nombre" name="nombre" required>
                    <input type="email" placeholder="Correo" id="correo" name="correo" required>
                    <textarea name="mensaje" id="mensaje" placeholder="Mensaje"></textarea>
                    <button class="boton" type="submit">Contactar</button>
                </form>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>&copy; 2025. Todos los derechos reservados. QuimiBot v2.0</p>
        </div>
    </footer>

    <script>
        // Variables globales
        let chatbot;
        let suggestedQuestions = [];
        
        // Preguntas sugeridas predeterminadas (se cargarán más del servidor)
        const defaultQuestions = [
            "¿Qué es un átomo?",
            "Explícame la tabla periódica",
            "¿Qué son los enlaces químicos?",
            "¿Qué es la electronegatividad?",
            "¿Cuáles son los números cuánticos?",
            "¿Qué es el modelo atómico de Bohr?",
            "Explícame los orbitales atómicos",
            "¿Qué es la configuración electrónica?",
            "¿Cuáles son los estados de la materia?",
            "¿Qué es el pH?",
            "¿Qué son los isótopos?",
            "Explícame las reacciones químicas",
            "¿Qué es la estequiometría?",
            "¿Qué son los metales alcalinos?",
            "¿Qué es la radiactividad?",
            "Explícame el efecto fotoeléctrico",
            "¿Qué es la teoría cuántica?",
            "¿Qué son los gases nobles?",
            "¿Qué es un mol?",
            "Explícame los enlaces covalentes",
            "¿Qué es la función de onda?",
            "¿Qué son los metaloides?",
            "Explícame el principio de Pauli",
            "¿Qué es la afinidad electrónica?",
            "¿Qué son los catalizadores?"
        ];

        // Función para cargar preguntas sugeridas del servidor
        async function loadSuggestedQuestions() {
            try {
                const response = await fetch('http://localhost:3000/api/suggested-questions');
                if (response.ok) {
                    const data = await response.json();
                    suggestedQuestions = data.questions || defaultQuestions;
                } else {
                    suggestedQuestions = defaultQuestions;
                }
            } catch (error) {
                console.log('Usando preguntas predeterminadas');
                suggestedQuestions = defaultQuestions;
            }
            
            displayQuickActions();
        }

        // Función para mostrar acciones rápidas
        function displayQuickActions() {
            const quickActionsContainer = document.getElementById('quick-actions');
            quickActionsContainer.innerHTML = '';
            
            // Mostrar 8 preguntas aleatorias
            const shuffled = [...suggestedQuestions].sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, 8);
            
            selected.forEach(question => {
                const button = document.createElement('button');
                button.className = 'quick-action';
                button.textContent = question;
                button.setAttribute('data-message', question);
                button.addEventListener('click', function() {
                    sendQuickMessage(this.getAttribute('data-message'));
                });
                quickActionsContainer.appendChild(button);
            });
        }

        // Función para formatear mensajes con markdown básico
        function formatMessage(content) {
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>')
                .replace(/•/g, '•')
                .replace(/₂/g, '₂')
                .replace(/₃/g, '₃')
                .replace(/⁺/g, '⁺')
                .replace(/⁻/g, '⁻');
        }

        // Función para agregar mensajes al chat
        function addMessage(content, type) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-${type === 'user' ? 'user' : 'robot'}"></i>
                </div>
                <div class="message-content">
                    ${formatMessage(content)}
                    <div class="message-time">${timeString}</div>
                </div>
            `;
            
            // Remover mensaje de bienvenida si existe
            const welcomeMessage = chatMessages.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }
            
            chatMessages.appendChild(messageDiv);
            
            // Scroll al final
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        // Función para mostrar indicador de escritura
        function showTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            typingIndicator.style.display = 'flex';
            
            const chatMessages = document.getElementById('chat-messages');
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        // Función para ocultar indicador de escritura
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            typingIndicator.style.display = 'none';
        }

        // Función para enviar mensaje al servidor
        async function sendMessageToServer(message) {
            try {
                const response = await fetch('http://localhost:3000/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.response;
                } else {
                    throw new Error('Error del servidor');
                }
            } catch (error) {
                console.error('Error al conectar con el servidor:', error);
                return 'Lo siento, no puedo conectar con el servidor en este momento. Por favor, verifica que el servidor esté ejecutándose en http://localhost:3000';
            }
        }

        // Función para enviar mensaje
        async function sendMessage() {
            const userInput = document.getElementById('user-input');
            const message = userInput.value.trim();
            
            if (!message) return;
            
            // Mostrar mensaje del usuario
            addMessage(message, 'user');
            userInput.value = '';
            adjustTextareaHeight();
            updateSendButtonState();
            
            // Mostrar indicador de escritura
            showTypingIndicator();
            
            // Enviar mensaje al servidor y mostrar respuesta
            const response = await sendMessageToServer(message);
            
            setTimeout(() => {
                hideTypingIndicator();
                addMessage(response, 'bot');
                
                // Actualizar preguntas sugeridas ocasionalmente
                if (Math.random() < 0.3) {
                    displayQuickActions();
                }
            }, 1000 + Math.random() * 1000);
        }

        // Función para ajustar altura del textarea
        function adjustTextareaHeight() {
            const userInput = document.getElementById('user-input');
            userInput.style.height = 'auto';
            userInput.style.height = Math.min(userInput.scrollHeight, 120) + 'px';
        }

        // Función para actualizar estado del botón enviar
        function updateSendButtonState() {
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const hasContent = userInput.value.trim().length > 0;
            sendBtn.disabled = !hasContent;
        }

        // Función para mensajes rápidos
        function sendQuickMessage(message) {
            const userInput = document.getElementById('user-input');
            userInput.value = message;
            userInput.focus();
            sendMessage();
        }

        // Función para verificar conexión al servidor
        async function checkServerConnection() {
            try {
                const response = await fetch('http://localhost:3000/api/health');
                if (response.ok) {
                    const data = await response.json();
                    const connectionStatus = document.getElementById('connection-status');
                    connectionStatus.className = 'connection-status';
                    connectionStatus.style.backgroundColor = '#d1fae5';
                    connectionStatus.style.color = '#065f46';
                    connectionStatus.innerHTML = `<i class="fas fa-check-circle"></i> Conectado al servidor v${data.version} - ${data.knowledgeBase.concepts} conceptos disponibles`;
                    
                    const statusText = document.getElementById('status-text');
                    statusText.textContent = 'Servidor conectado';
                    
                    console.log('Servidor conectado:', data);
                }
            } catch (error) {
                console.log('Funcionando en modo local');
                const connectionStatus = document.getElementById('connection-status');
                connectionStatus.style.backgroundColor = '#fef3c7';
                connectionStatus.style.color = '#92400e';
                connectionStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Servidor no disponible - Verifica que esté ejecutándose en http://localhost:3000';
            }
        }

        // Inicialización cuando se carga la página
        document.addEventListener('DOMContentLoaded', function() {
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            
            // Event listeners
            sendBtn.addEventListener('click', sendMessage);
            
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            userInput.addEventListener('input', function() {
                adjustTextareaHeight();
                updateSendButtonState();
            });
            
            // Auto-focus en el input
            userInput.focus();
            
            // Cargar preguntas sugeridas
            loadSuggestedQuestions();
            
            // Verificar conexión al servidor
            checkServerConnection();
            
            console.log('QuimiBot v2.0 inicializado');
        });
    </script>
</body>
</html>
